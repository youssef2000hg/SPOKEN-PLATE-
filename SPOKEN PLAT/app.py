from flask import Flask, render_template, request, jsonify, session
import speech_recognition as sr
import requests
import time
import re
from gtts import gTTS
import pygame
import tempfile
import os
import json
from datetime import datetime, timedelta
import google.generativeai as genai
import base64
import io
from threading import Thread
import uuid

app = Flask(__name__)
app.secret_key = 'spoken_plate_secret_key'

class ุงููุณุงุนุฏุงูุฐูููููุทุงุนู:
    def __init__(self):
        # ุชููุฆุฉ Gemini AI
        self.ููุชุงุญ_gemini = "AIzaSyBQN5tQbkT_npmzeyFsivCPHBvKIvtju7Q"
        genai.configure(api_key=self.ููุชุงุญ_gemini)
        self.ูููุฐุฌ_gemini = genai.GenerativeModel('gemini-pro')
        
        # ุชููุฆุฉ ุงูุชุนุฑู ุนูู ุงูุตูุช
        self.ูุชุนุฑู_ุงูุตูุช = sr.Recognizer()
        
        # ุชููุฆุฉ ุงูุตูุช
        try:
            pygame.mixer.init()
            print("๐ ุชู ุชููุฆุฉ ูุธุงู ุงูุตูุช")
        except Exception as e:
            print(f"โ ุชุนุฐุฑ ุชููุฆุฉ ุงูุตูุช: {e}")
        
        # ูุงุนุฏุฉ ุจูุงูุงุช ุงููุทุงุนู
        self.ูุงุนุฏุฉ_ุงูุจูุงูุงุช = {}
        self.ุขุฎุฑ_ุชุญุฏูุซ = None
        self.ุงููุทุนู_ุงูุญุงูู = None
        self.ุงููุญุงุฏุซุฉ_ุงูุฃุฎูุฑุฉ = ""
        self.ุงููุญุงุฏุซุงุช = []
        self.ุชุญุฏูุซ_ุงูุจูุงูุงุช()

    def ุชุญุฏูุซ_ุงูุจูุงูุงุช(self):
        """ุชุญุฏูุซ ุจูุงูุงุช ุงููุทุงุนู ุชููุงุฆูุงู"""
        print("๐ ุฌุงุฑู ุชุญุฏูุซ ุจูุงูุงุช ุงููุทุงุนู...")
        self.ูุงุนุฏุฉ_ุงูุจูุงูุงุช = self._ุชููุฆุฉ_ูุงุนุฏุฉ_ุงูุจูุงูุงุช_ุงููุงููุฉ()
        self.ุขุฎุฑ_ุชุญุฏูุซ = datetime.now()
        print("โ ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุจูุฌุงุญ")

    def _ุงุณุชุนูุงู_gemini(self, ุงุณุชุนูุงู):
        """ุงุณุชุฎุฏุงู Gemini AI ููุฅุฌุงุจุฉ ุนูู ุงูุงุณุชูุณุงุฑุงุช"""
        try:
            # ุฅุถุงูุฉ ุณูุงู ุงููุทุงุนู ููุงุณุชุนูุงู
            ุณูุงู_ุงููุทุงุนู = f"""
            ุฃูุง ูุณุงุนุฏ ุฐูู ูููุทุงุนู. ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชุญุชูู ุนูู:
            {json.dumps(self.ูุงุนุฏุฉ_ุงูุจูุงูุงุช, ensure_ascii=False)}
            
            ุงููุทุนู ุงูุญุงูู ุงููุญุฏุฏ: {self.ุงููุทุนู_ุงูุญุงูู}
            
            ุงูุงุณุชุนูุงู: {ุงุณุชุนูุงู}
            
            ุฃุฌุจ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุจุทุฑููุฉ ูุฏูุฏุฉ ููููุฏุฉ. ูู ุฏูููุงู ูู ุงููุนูููุงุช ุญูู ุงูุฃุณุนุงุฑ ูุงูููููุงุช.
            """
            
            response = self.ูููุฐุฌ_gemini.generate_content(ุณูุงู_ุงููุทุงุนู)
            return response.text
        except Exception as e:
            return f"ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ุงููุนุงูุฌุฉ: {str(e)}"

    def _ุชููุฆุฉ_ูุงุนุฏุฉ_ุงูุจูุงูุงุช_ุงููุงููุฉ(self):
        """ูุงุนุฏุฉ ุจูุงูุงุช ูุงููุฉ ูุฌููุน ุงููุทุงุนู"""
        return {
            "ูุงูุฏููุงูุฏุฒ": {
                "ุงููุฌุจุงุช": [
                    {'ุงุณู': 'ุจูุฌ ูุงู', 'ุณุนุฑ': 'ูจูฅ ุฌููู', 'ููููุงุช': 'ูุทุนุชุงู ูุญู ุจูุฑ ูกูููชุ ุตูุต ุจูุฌ ูุงู ุฎุงุตุ ุฎุณ ุทุงุฒุฌุ ุฌุจูุฉ ุดูุฏุฑุ ูุฎููุ ุจุตูุ ุฎุจุฒ ุจุงูุณูุณู', 'ูุฆุฉ': 'ุจุฑุฌุฑ'},
                    {'ุงุณู': 'ุจูุฌ ุชุงุณุชู', 'ุณุนุฑ': 'ูงูฅ ุฌููู', 'ููููุงุช': 'ูุทุนุฉ ูุญู ุจูุฑู ูุจูุฑุฉุ ุฌุจูุฉ ุดูุฏุฑุ ุฎุณุ ุทูุงุทูุ ุจุตูุ ุตูุต ุจูุฌ ุชุงุณุชูุ ุฎุจุฒ', 'ูุฆุฉ': 'ุจุฑุฌุฑ'},
                    {'ุงุณู': 'ุชุดูุฒ ุจุฑุฌุฑ', 'ุณุนุฑ': 'ูขูฅ ุฌููู', 'ููููุงุช': 'ูุทุนุฉ ูุญู ุจูุฑูุ ุดุฑูุญุฉ ุฌุจูุฉุ ูุฎููุ ุจุตูุ ูุงุชุดุจุ ุฎุฑุฏูุ ุฎุจุฒ', 'ูุฆุฉ': 'ุจุฑุฌุฑ'},
                    {'ุงุณู': 'ูุงู ุชุดููู', 'ุณุนุฑ': 'ูฃูฅ ุฌููู', 'ููููุงุช': 'ูุทุนุฉ ุฏุฌุงุฌ ููุฑูุดุฉุ ุฎุณ ุทุงุฒุฌุ ูุงููููุฒุ ุฎุจุฒ ูุญูุต', 'ูุฆุฉ': 'ุฏุฌุงุฌ'},
                    {'ุงุณู': 'ุชุดููู ูุงู ูุงุฌุชุณ ูฆ ูุทุน', 'ุณุนุฑ': 'ูฃู ุฌููู', 'ููููุงุช': 'ุณุช ูุทุน ุฏุฌุงุฌ ูุงุฌุชุณุ ุจูุณูุงุทุ ุฒูุช ูุจุงุชู', 'ูุฆุฉ': 'ุฏุฌุงุฌ'},
                    {'ุงุณู': 'ูุงุจู ููู ุชุดูุฒ ุจุฑุฌุฑ', 'ุณุนุฑ': 'ูคู ุฌููู', 'ููููุงุช': 'ุชุดูุฒ ุจุฑุฌุฑุ ุจุทุงุทุณ ุตุบูุฑุฉุ ูุดุฑูุจุ ูุนุจุฉ ุฃุทูุงู', 'ูุฆุฉ': 'ูุฌุจุงุช ุณุนูุฏุฉ'},
                    {'ุงุณู': 'ุจุทุงุทุณ ููููุฉ ูุจูุฑุฉ', 'ุณุนุฑ': 'ูขู ุฌููู', 'ููููุงุช': 'ุจุทุงุทุณ ุทุงุฒุฌุฉุ ุฒูุช ูุจุงุชูุ ููุญ', 'ูุฆุฉ': 'ููุจูุงุช'},
                    {'ุงุณู': 'ูููุง', 'ุณุนุฑ': 'ูกูข ุฌููู', 'ููููุงุช': 'ูุดุฑูุจ ุบุงุฒู', 'ูุฆุฉ': 'ูุดุฑูุจุงุช'},
                    {'ุงุณู': 'ูุงู ูููุฑู ุฃูุฑูู', 'ุณุนุฑ': 'ูขูฅ ุฌููู', 'ููููุงุช': 'ุขูุณ ูุฑูู ูุงููููุงุ ุจุณูููุช ุฃูุฑููุ ุดููููุงุชุฉ', 'ูุฆุฉ': 'ุญูููุงุช'},
                ],
                "ุงููุฆุงุช": ['ุจุฑุฌุฑ', 'ุฏุฌุงุฌ', 'ูุฌุจุงุช ุณุนูุฏุฉ', 'ููุจูุงุช', 'ูุดุฑูุจุงุช', 'ุญูููุงุช'],
                "ุงูุนุฑูุถ": ["ุนุฑุถ ุงูุจูุฌ ูุงู ุจุฎุตู ูกููช", "ูุงุจู ููู ุจูุฏูุฉ ูุฌุงููุฉ"],
                "ูุนูููุงุช": "ูุงูุฏููุงูุฏุฒ - ุฃุดูุฑ ูุทุงุนู ุงููุฌุจุงุช ุงูุณุฑูุนุฉ ูู ุงูุนุงูู"
            },
            "ููุชุงูู": {
                "ุงููุฌุจุงุช": [
                    {'ุงุณู': 'ูุฌุจุฉ ุฒูุฌุฑ', 'ุณุนุฑ': 'ูงู ุฌููู', 'ููููุงุช': 'ูุทุนุฉ ุฏุฌุงุฌ ุฒูุฌุฑุ ุจุทุงุทุณุ ุฎุจุฒุ ุตูุตุ ูุดุฑูุจ', 'ูุฆุฉ': 'ูุฌุจุงุช'},
                    {'ุงุณู': 'ุจููุณ ูุงุณุชุฑ', 'ุณุนุฑ': 'ูกูู ุฌููู', 'ููููุงุช': 'ูค ูุทุน ุฏุฌุงุฌุ ุจุทุงุทุณุ ุตูุตุ ุฎุจุฒุ ูุดุฑูุจ', 'ูุฆุฉ': 'ูุฌุจุงุช'},
                    {'ุงุณู': 'ุฏุฌุงุฌ ููุท ูค ูุทุน', 'ุณุนุฑ': 'ูจูฅ ุฌููู', 'ููููุงุช': 'ูค ูุทุน ุฏุฌุงุฌ ูููู', 'ูุฆุฉ': 'ุฏุฌุงุฌ'},
                    {'ุงุณู': 'ุจุฑุฌุฑ ุฏุฌุงุฌ', 'ุณุนุฑ': 'ูฃูฅ ุฌููู', 'ููููุงุช': 'ุจุฑุฌุฑ ุฏุฌุงุฌุ ุฎุณุ ุทูุงุทูุ ูุงููููุฒ', 'ูุฆุฉ': 'ุจุฑุฌุฑ'},
                    {'ุงุณู': 'ุณูุทุฉ ููู ุณูู', 'ุณุนุฑ': 'ูกูฅ ุฌููู', 'ููููุงุช': 'ุณูุทุฉ ุทุงุฒุฌุฉ ูุน ุตูุต ุฎุงุต', 'ูุฆุฉ': 'ููุจูุงุช'},
                ],
                "ุงููุฆุงุช": ['ูุฌุจุงุช', 'ุฏุฌุงุฌ', 'ุจุฑุฌุฑ', 'ููุจูุงุช', 'ูุดุฑูุจุงุช'],
                "ุงูุนุฑูุถ": ["ูุฌุจุชูู ุฒูุฌุฑ ุจุณุนุฑ ูกูขู ุฌููู", "ุนุฑุถ ุงูุนุงุฆูุฉ ุจุฎุตู ูกูฅูช"],
                "ูุนูููุงุช": "ููุชุงูู - ุฃุดูุฑ ูุทุงุนู ุงูุฏุฌุงุฌ ุงููููู ูู ุงูุนุงูู"
            },
            "ุจูุชุฒุง ูุช": {
                "ุงููุฌุจุงุช": [
                    {'ุงุณู': 'ุจูุชุฒุง ุจูุจุฑููู ูุจูุฑุฉ', 'ุณุนุฑ': 'ูกูขู ุฌููู', 'ููููุงุช': 'ุจูุจุฑูููุ ุฌุจูุฉ ููุฒุงุฑููุงุ ุตูุต ุทูุงุทู', 'ูุฆุฉ': 'ุจูุชุฒุง'},
                    {'ุงุณู': 'ุจูุชุฒุง ูุงุฑุฌุฑูุชุง ูุจูุฑุฉ', 'ุณุนุฑ': 'ูจู ุฌููู', 'ููููุงุช': 'ุฌุจูุฉ ููุฒุงุฑููุงุ ุตูุต ุทูุงุทูุ ุฑูุญุงู', 'ูุฆุฉ': 'ุจูุชุฒุง'},
                    {'ุงุณู': 'ุจูุชุฒุง ุณูุจุฑ ุณูุจุฑู', 'ุณุนุฑ': 'ูกูฃู ุฌููู', 'ููููุงุช': 'ุฌููุน ุงููุญูู ูุงูุฎุถุงุฑุ ุฌุจูุฉ ูุฒุฏูุฌุฉ', 'ูุฆุฉ': 'ุจูุชุฒุง'},
                    {'ุงุณู': 'ุฃุฌูุญุฉ ุฏุฌุงุฌ ูกู ูุทุน', 'ุณุนุฑ': 'ูฆูฅ ุฌููู', 'ููููุงุช': 'ูกู ูุทุน ุฃุฌูุญุฉ ุฏุฌุงุฌ ูุน ุตูุต', 'ูุฆุฉ': 'ููุจูุงุช'},
                ],
                "ุงููุฆุงุช": ['ุจูุชุฒุง', 'ููุจูุงุช', 'ูุดุฑูุจุงุช'],
                "ุงูุนุฑูุถ": ["ุดุฑุงุก ุจูุชุฒุง ูุจูุฑุฉ ูุงุญุตู ุนูู ุตุบูุฑุฉ ูุฌุงูุงู", "ุฎุตู ูขููช ุนูู ุงูุทูุจุงุช ููู ูกูฅู ุฌููู"],
                "ูุนูููุงุช": "ุจูุชุฒุง ูุช - ุฃุดูุฑ ูุทุงุนู ุงูุจูุชุฒุง ูู ุงูุนุงูู"
            },
            "ูุงุฑุฏูุฒ": {
                "ุงููุฌุจุงุช": [
                    {'ุงุณู': 'ุจุฑุฌุฑ ุจูููู', 'ุณุนุฑ': 'ูฆูฅ ุฌููู', 'ููููุงุช': 'ูุญู ุจูุฑูุ ุจููููุ ุฌุจูุฉุ ุฎุณุ ุทูุงุทูุ ุตูุต ุฎุงุต', 'ูุฆุฉ': 'ุจุฑุฌุฑ'},
                    {'ุงุณู': 'ุจุฑุฌุฑ ุฏุจู', 'ุณุนุฑ': 'ูจูฅ ุฌููู', 'ููููุงุช': 'ูุทุนุชุงู ูุญู ุจูุฑูุ ุฌุจูุฉุ ุฎุณุ ุตูุต ุฎุงุต', 'ูุฆุฉ': 'ุจุฑุฌุฑ'},
                    {'ุงุณู': 'ูููู ุดูู ุดููููุงุชุฉ', 'ุณุนุฑ': 'ูขูฅ ุฌููู', 'ููููุงุช': 'ูููู ุดูู ุจุงูุดููููุงุชุฉ', 'ูุฆุฉ': 'ูุดุฑูุจุงุช'},
                ],
                "ุงููุฆุงุช": ['ุจุฑุฌุฑ', 'ููุจูุงุช', 'ูุดุฑูุจุงุช'],
                "ุงูุนุฑูุถ": ["ุจุฑุฌุฑ ูุฌุงูู ูุน ุดุฑุงุก ุจุฑุฌุฑ ุฏุจู", "ุฎุตู ูกููช ุนูู ุฌููุน ุงููุฌุจุงุช"],
                "ูุนูููุงุช": "ูุงุฑุฏูุฒ - ูุทุนู ุจุฑุฌุฑ ุฃูุฑููู ุดููุฑ"
            },
            "ูููู": {
                "ุงููุฌุจุงุช": [
                    {'ุงุณู': 'ุณุงูุฏููุชุด ุฑููู', 'ุณุนุฑ': 'ูคูฅ ุฌููู', 'ููููุงุช': 'ูุญู ุฑูููุ ุฌุจูุฉุ ุฎุณุ ุทูุงุทูุ ูุงููููุฒ', 'ูุฆุฉ': 'ุณุงูุฏููุชุด'},
                    {'ุงุณู': 'ุณุงูุฏููุชุด ุชููุฉ', 'ุณุนุฑ': 'ูฃูฅ ุฌููู', 'ููููุงุช': 'ุชููุฉุ ูุงููููุฒุ ุฎุณุ ุทูุงุทู', 'ูุฆุฉ': 'ุณุงูุฏููุชุด'},
                    {'ุงุณู': 'ุณูุทุฉ ูููู', 'ุณุนุฑ': 'ูฃู ุฌููู', 'ููููุงุช': 'ุฎุณุ ุทูุงุทูุ ุฎูุงุฑุ ุฌุจูุฉุ ุฒูุชูู', 'ูุฆุฉ': 'ุณูุทุงุช'},
                ],
                "ุงููุฆุงุช": ['ุณุงูุฏููุชุด', 'ุณูุทุงุช', 'ูุดุฑูุจุงุช'],
                "ุงูุนุฑูุถ": ["ุดุฑุงุก ุณุงูุฏููุชุดูู ูุงุญุตู ุนูู ูุดุฑูุจ ูุฌุงูู", "ุฎุตู ูกูฅูช ุนูู ุงูุทูุจุงุช ููู ูฅู ุฌููู"],
                "ูุนูููุงุช": "ูููู - ูุทุนู ุณุงูุฏููุชุดุงุช ูุณูุทุงุช"
            }
        }

    def _ูุทู_ููููุจ(self, ูุต):
        """ุฅูุดุงุก ููู ุตูุชู ููููุจ"""
        try:
            # ุญูุธ ุงููุญุงุฏุซุฉ ุงูุฃุฎูุฑุฉ
            self.ุงููุญุงุฏุซุฉ_ุงูุฃุฎูุฑุฉ = ูุต
            
            with tempfile.NamedTemporaryFile(delete=False, suffix='.mp3') as ููู:
                ูุณุงุฑ_ุงูููู = ููู.name
            
            tts = gTTS(text=ูุต, lang='ar', slow=False)
            tts.save(ูุณุงุฑ_ุงูููู)
            
            # ูุฑุงุกุฉ ุงูููู ูุชุญูููู ุฅูู base64
            with open(ูุณุงุฑ_ุงูููู, 'rb') as audio_file:
                audio_data = audio_file.read()
            
            # ุชูุธูู ุงูููู ุงููุคูุช
            try:
                os.unlink(ูุณุงุฑ_ุงูููู)
            except:
                pass
            
            return base64.b64encode(audio_data).decode('utf-8')
            
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ุงููุทู: {e}")
            return None

    def _ุงูุงุณุชูุงุน_ููุตูุช(self, audio_data=None):
        """ุงูุงุณุชูุงุน ููุฃูุงูุฑ ุงูุตูุชูุฉ"""
        try:
            if audio_data:
                # ูุนุงูุฌุฉ ุจูุงูุงุช ุตูุชูุฉ ูู ุงูููุจ
                with tempfile.NamedTemporaryFile(delete=False, suffix='.wav') as temp_file:
                    temp_file.write(audio_data)
                    temp_path = temp_file.name
                
                with sr.AudioFile(temp_path) as source:
                    audio = self.ูุชุนุฑู_ุงูุตูุช.record(source)
                
                # ุชูุธูู ุงูููู ุงููุคูุช
                try:
                    os.unlink(temp_path)
                except:
                    pass
            else:
                # ุงูุงุณุชูุงุน ูู ุงููููุฑูููู
                with sr.Microphone() as ูุตุฏุฑ:
                    print("๐ง ุฌุงุฑู ุงูุงุณุชูุงุน ูู...")
                    self.ูุชุนุฑู_ุงูุตูุช.adjust_for_ambient_noise(ูุตุฏุฑ, duration=1)
                    audio = self.ูุชุนุฑู_ุงูุตูุช.listen(ูุตุฏุฑ, timeout=10, phrase_time_limit=8)
                
            ูุต = self.ูุชุนุฑู_ุงูุตูุช.recognize_google(audio, language="ar-AR")
            print(f"๐ ุณูุนุช: {ูุต}")
            return ูุต
            
        except sr.WaitTimeoutError:
            return "timeout"
        except sr.UnknownValueError:
            return "unknown"
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ุงูุชุนุฑู ุนูู ุงูุตูุช: {e}")
            return "error"

    def _ูุนุงูุฌุฉ_ุงูุฃูุฑ_ุงูุฐูู(self, ุงูุฃูุฑ):
        """ุงุณุชุฎุฏุงู Gemini AI ูููู ุงูุฃูุงูุฑ ุงููุนูุฏุฉ"""
        try:
            ุงุณุชุนูุงู = f"""
            ุงููุณุชุฎุฏู ูุงู: "{ุงูุฃูุฑ}"
            
            ุงููุทุนู ุงูุญุงูู: {self.ุงููุทุนู_ุงูุญุงูู}
            
            ุงูููุงู ุงููุญุชููุฉ:
            - ุงุฎุชูุงุฑ ูุทุนู
            - ุนุฑุถ ุงููุงุฆูุฉ
            - ุงูุจุญุซ ุนู ูุฌุจุฉ
            - ูุนุฑูุฉ ุงูุณุนุฑ
            - ูุนุฑูุฉ ุงูููููุงุช
            - ุนุฑุถ ุงูุนุฑูุถ
            - ููุงุฑูุฉ ุงูุฃุณุนุงุฑ
            - ุชูุตูุฉ ูุฌุจุฉ
            - ุงุณุชูุณุงุฑ ุนุงู
            
            ุฃุฌุจ ุจุฅุญุฏู ุงูุทุฑู ุงูุชุงููุฉ:
            1. ุฅุฐุง ูุงู ุงูุฃูุฑ ุจุณูุทุงู (ุงุฎุชูุงุฑ ูุทุนูุ ุนุฑุถ ูุงุฆูุฉุ ุฅูุฎ) - ุฃุนุฏ ุงููุต ููุง ูู
            2. ุฅุฐุง ูุงู ุงูุฃูุฑ ูุนูุฏุงู (ุฃุณุฆูุฉุ ููุงุฑูุงุชุ ุชูุตูุงุช) - ุฃุฌุจ ูุจุงุดุฑุฉ
            
            ูู ุฐููุงู ูู ุงูุฑุฏ ูุญุงูู ููู ููุฉ ุงููุณุชุฎุฏู.
            """
            
            response = self.ูููุฐุฌ_gemini.generate_content(ุงุณุชุนูุงู)
            return response.text.strip()
            
        except Exception as e:
            return ุงูุฃูุฑ

    def _ุชูููุฐ_ุงูุฃูุฑ(self, ุงูุฃูุฑ):
        """ุชูููุฐ ุงูุฃูุงูุฑ ุงูุฃุณุงุณูุฉ"""
        ุงูุฃูุฑ = ุงูุฃูุฑ.lower()
        
        # ุงุฎุชูุงุฑ ูุทุนู
        for ูุทุนู in self.ูุงุนุฏุฉ_ุงูุจูุงูุงุช.keys():
            if ูุทุนู in ุงูุฃูุฑ:
                self.ุงููุทุนู_ุงูุญุงูู = ูุทุนู
                return f"ุชู ุงุฎุชูุงุฑ {ูุทุนู}. {self.ูุงุนุฏุฉ_ุงูุจูุงูุงุช[ูุทุนู]['ูุนูููุงุช']}"
        
        # ุงูุฃูุงูุฑ ุงูุฃุณุงุณูุฉ
        if any(ูููุฉ in ุงูุฃูุฑ for ูููุฉ in ['ูุงุฆูุฉ', 'ุงููููู', 'ุงูุทุนุงู']):
            if self.ุงููุทุนู_ุงูุญุงูู:
                return self._ุนุฑุถ_ุงููุงุฆูุฉ()
            else:
                return "ูู ูุถูู ุงุฎุชุฑ ูุทุนู ุฃููุงู"
            
        elif any(ูููุฉ in ุงูุฃูุฑ for ูููุฉ in ['ุณุนุฑ', 'ุจูุงู', 'ูู ุณุนุฑ']):
            if self.ุงููุทุนู_ุงูุญุงูู:
                return self._ุงูุจุญุซ_ุนู_ุณุนุฑ(ุงูุฃูุฑ)
            else:
                return "ูู ูุถูู ุงุฎุชุฑ ูุทุนู ุฃููุงู"
            
        elif any(ูููุฉ in ุงูุฃูุฑ for ูููุฉ in ['ููููุงุช', 'ูุญุชูู']):
            if self.ุงููุทุนู_ุงูุญุงูู:
                return self._ุงูุจุญุซ_ุนู_ููููุงุช(ุงูุฃูุฑ)
            else:
                return "ูู ูุถูู ุงุฎุชุฑ ูุทุนู ุฃููุงู"
            
        elif any(ูููุฉ in ุงูุฃูุฑ for ูููุฉ in ['ุนุฑูุถ', 'ุฎุตููุงุช']):
            if self.ุงููุทุนู_ุงูุญุงูู:
                return self._ุนุฑุถ_ุงูุนุฑูุถ()
            else:
                return "ูู ูุถูู ุงุฎุชุฑ ูุทุนู ุฃููุงู"
            
        elif any(ูููุฉ in ุงูุฃูุฑ for ูููุฉ in ['ุงููุทุงุนู', 'ูุงุฆูุฉ ุงููุทุงุนู']):
            return self._ุนุฑุถ_ุงููุทุงุนู()
            
        elif any(ูููุฉ in ุงูุฃูุฑ for ูููุฉ in ['ูุณุงุนุฏุฉ', 'ูุณุงุนุฏู']):
            return self._ุนุฑุถ_ุงููุณุงุนุฏุฉ()
            
        elif any(ูููุฉ in ุงูุฃูุฑ for ูููุฉ in ['ุชููู', 'ุงููุงุก', 'ุฎุฑูุฌ']):
            return "ุชููู"
        
        return None

    def _ุนุฑุถ_ุงููุงุฆูุฉ(self):
        """ุนุฑุถ ูุงุฆูุฉ ุงููุทุนู ุงูุญุงูู"""
        if not self.ุงููุทุนู_ุงูุญุงูู:
            return "ูู ูุถูู ุงุฎุชุฑ ูุทุนู ุฃููุงู"
            
        ูุทุนู = self.ูุงุนุฏุฉ_ุงูุจูุงูุงุช[self.ุงููุทุนู_ุงูุญุงูู]
        ูุต = f"ูุงุฆูุฉ {self.ุงููุทุนู_ุงูุญุงูู}: "
        
        for ูุฆุฉ in ูุทุนู['ุงููุฆุงุช']:
            ูุฌุจุงุช_ุงููุฆุฉ = [ู for ู in ูุทุนู['ุงููุฌุจุงุช'] if ู['ูุฆุฉ'] == ูุฆุฉ]
            ูุต += f"{ูุฆุฉ}: "
            for ูุฌุจุฉ in ูุฌุจุงุช_ุงููุฆุฉ[:3]:
                ูุต += f"{ูุฌุจุฉ['ุงุณู']} ุจุณุนุฑ {ูุฌุจุฉ['ุณุนุฑ']}. "
            ูุต += "... "
            
        ูุต += "ูู ุงุณู ุงููุฌุจุฉ ููุนุฑูุฉ ุงููุฒูุฏ ูู ุงูุชูุงุตูู."
        return ูุต

    def _ุงูุจุญุซ_ุนู_ุณุนุฑ(self, ุงูุฃูุฑ):
        """ุงูุจุญุซ ุนู ุณุนุฑ ูุฌุจุฉ"""
        for ูุฌุจุฉ in self.ูุงุนุฏุฉ_ุงูุจูุงูุงุช[self.ุงููุทุนู_ุงูุญุงูู]['ุงููุฌุจุงุช']:
            if ูุฌุจุฉ['ุงุณู'].lower() in ุงูุฃูุฑ:
                return f"ุณุนุฑ {ูุฌุจุฉ['ุงุณู']} ูู {ูุฌุจุฉ['ุณุนุฑ']}"
        return "ูู ุฃุฌุฏ ุงููุฌุจุฉ ุงูุชู ุชุจุญุซ ุนููุง"

    def _ุงูุจุญุซ_ุนู_ููููุงุช(self, ุงูุฃูุฑ):
        """ุงูุจุญุซ ุนู ููููุงุช ูุฌุจุฉ"""
        for ูุฌุจุฉ in self.ูุงุนุฏุฉ_ุงูุจูุงูุงุช[self.ุงููุทุนู_ุงูุญุงูู]['ุงููุฌุจุงุช']:
            if ูุฌุจุฉ['ุงุณู'].lower() in ุงูุฃูุฑ:
                return f"ููููุงุช {ูุฌุจุฉ['ุงุณู']}: {ูุฌุจุฉ['ููููุงุช']}"
        return "ูู ุฃุฌุฏ ุงููุฌุจุฉ ุงูุชู ุชุจุญุซ ุนููุง"

    def _ุนุฑุถ_ุงูุนุฑูุถ(self):
        """ุนุฑุถ ุนุฑูุถ ุงููุทุนู ุงูุญุงูู"""
        ุนุฑูุถ = self.ูุงุนุฏุฉ_ุงูุจูุงูุงุช[self.ุงููุทุนู_ุงูุญุงูู].get('ุงูุนุฑูุถ', [])
        if ุนุฑูุถ:
            return f"ุนุฑูุถ {self.ุงููุทุนู_ุงูุญุงูู}: " + ". ".join(ุนุฑูุถ)
        else:
            return f"ูุง ุชูุฌุฏ ุนุฑูุถ ุญุงููุฉ ูู {self.ุงููุทุนู_ุงูุญุงูู}"

    def _ุนุฑุถ_ุงููุทุงุนู(self):
        """ุนุฑุถ ูุงุฆูุฉ ุงููุทุงุนู ุงููุชุงุญุฉ"""
        ุงููุทุงุนู = list(self.ูุงุนุฏุฉ_ุงูุจูุงูุงุช.keys())
        return f"ุงููุทุงุนู ุงููุชุงุญุฉ: {', '.join(ุงููุทุงุนู)}. ูู ุงุณู ุงููุทุนู ุงูุฐู ุชุฑูุฏู"

    def _ุนุฑุถ_ุงููุณุงุนุฏุฉ(self):
        """ุนุฑุถ ูุงุฆูุฉ ุงููุณุงุนุฏุฉ"""
        return """
        ุฃูุง ุงููุณุงุนุฏ ุงูุฐูู ูููุทุงุนู ุงููุฏุนูู ุจุฐูุงุก Gemini AI.
        
        ุงูุฃูุงูุฑ ุงูุฃุณุงุณูุฉ:
        - ูู ุงุณู ุงููุทุนู ูุซู "ูุงูุฏููุงูุฏุฒ" ุฃู "ููุชุงูู"
        - "ูุงุฆูุฉ" ูุนุฑุถ ูุงุฆูุฉ ุงููุทุนู
        - "ุณุนุฑ" ุซู ุงุณู ุงููุฌุจุฉ ููุนุฑูุฉ ุงูุณุนุฑ
        - "ููููุงุช" ุซู ุงุณู ุงููุฌุจุฉ ููุนุฑูุฉ ุงูููููุงุช
        - "ุนุฑูุถ" ูุนุฑุถ ุงูุนุฑูุถ ุงูุญุงููุฉ
        - "ุงููุทุงุนู" ูุฑุคูุฉ ุฌููุน ุงููุทุงุนู
        - "ูุณุงุนุฏุฉ" ูุนุฑุถ ูุฐู ุงูุฑุณุงูุฉ
        
        ููููู ุฃูุถุงู ุณุคุงู ุฃุณุฆูุฉ ุฐููุฉ!
        """

    def ูุนุงูุฌุฉ_ุงูุทูุจ(self, ูุต_ุงูุทูุจ, audio_data=None):
        """ูุนุงูุฌุฉ ุทูุจ ุงููุณุชุฎุฏู"""
        try:
            if audio_data:
                ูุต_ุงูุทูุจ = self._ุงูุงุณุชูุงุน_ููุตูุช(audio_data)
                if ูุต_ุงูุทูุจ in ["timeout", "unknown", "error"]:
                    return "ูู ุฃููู ูุง ููุชูุ ุฌุฑุจ ูุฑุฉ ุฃุฎุฑู", None
            
            # ุญูุธ ุงููุญุงุฏุซุฉ
            self.ุงููุญุงุฏุซุงุช.append({"ููุน": "ูุณุชุฎุฏู", "ูุต": ูุต_ุงูุทูุจ, "ููุช": datetime.now()})
            
            # ูุนุงูุฌุฉ ุงูุฃูุฑ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
            ุฃูุฑ_ููุนุงูุฌ = self._ูุนุงูุฌุฉ_ุงูุฃูุฑ_ุงูุฐูู(ูุต_ุงูุทูุจ)
            print(f"๐ค ุงูุฃูุฑ ุงูููุนุงูุฌ: {ุฃูุฑ_ููุนุงูุฌ}")
            
            # ูุญุงููุฉ ุชูููุฐ ุงูุฃูุฑ ุงูุฃุณุงุณู ุฃููุงู
            ูุชูุฌุฉ = self._ุชูููุฐ_ุงูุฃูุฑ(ุฃูุฑ_ููุนุงูุฌ)
            
            if ูุชูุฌุฉ == "ุชููู":
                return "ูุน ุงูุณูุงูุฉ! ูุชููู ูู ูุฌุจุฉ ุดููุฉ", None
            elif ูุชูุฌุฉ:
                audio_base64 = self._ูุทู_ููููุจ(ูุชูุฌุฉ)
                self.ุงููุญุงุฏุซุงุช.append({"ููุน": "ูุณุงุนุฏ", "ูุต": ูุชูุฌุฉ, "ููุช": datetime.now()})
                return ูุชูุฌุฉ, audio_base64
            else:
                # ุฅุฐุง ูู ููู ุฃูุฑุงู ุฃุณุงุณูุงูุ ุงุณุชุฎุฏุงู Gemini ููุฑุฏ
                ุฑุฏ = self._ุงุณุชุนูุงู_gemini(ูุต_ุงูุทูุจ)
                audio_base64 = self._ูุทู_ููููุจ(ุฑุฏ)
                self.ุงููุญุงุฏุซุงุช.append({"ููุน": "ูุณุงุนุฏ", "ูุต": ุฑุฏ, "ููุช": datetime.now()})
                return ุฑุฏ, audio_base64
                
        except Exception as e:
            error_msg = f"ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ: {str(e)}"
            return error_msg, None

# ุฅูุดุงุก ูุณุฎุฉ ูู ุงููุณุงุนุฏ
ูุณุงุนุฏ = ุงููุณุงุนุฏุงูุฐูููููุทุงุนู()

# routes Flask
@app.route('/')
def ุงูุฑุฆูุณูุฉ():
    return render_template('index.html', 
                         ุงููุทุนู_ุงูุญุงูู=ูุณุงุนุฏ.ุงููุทุนู_ุงูุญุงูู,
                         ุงููุญุงุฏุซุงุช=ูุณุงุนุฏ.ุงููุญุงุฏุซุงุช)

@app.route('/api/ุจุฏุก_ุงููุณุงุนุฏ', methods=['POST'])
def ุจุฏุก_ุงููุณุงุนุฏ():
    try:
        # ุจุฏุก ุงููุณุงุนุฏ ุชููุงุฆูุงู
        ุชุฑุญูุจ = "ูุฑุญุจุงู ุจู ูู SPOKEN PLATE! ุฃูุง ุงููุณุงุนุฏ ุงูุฐูู ูููุทุงุนู. ูู ุงุณู ุงููุทุนู ุงูุฐู ุชุฑูุฏู ูุซู ูุงูุฏููุงูุฏุฒ ุฃู ููุชุงููุ ุฃู ูู ูุณุงุนุฏุฉ ููุนุฑูุฉ ุงูุฃูุงูุฑ ุงููุชุงุญุฉ."
        audio_base64 = ูุณุงุนุฏ._ูุทู_ููููุจ(ุชุฑุญูุจ)
        
        ูุณุงุนุฏ.ุงููุญุงุฏุซุงุช.append({"ููุน": "ูุณุงุนุฏ", "ูุต": ุชุฑุญูุจ, "ููุช": datetime.now()})
        
        return jsonify({
            'ูุฌุงุญ': True,
            'ุฑุฏ': ุชุฑุญูุจ,
            'audio': audio_base64,
            'ุงููุทุนู_ุงูุญุงูู': ูุณุงุนุฏ.ุงููุทุนู_ุงูุญุงูู
        })
        
    except Exception as e:
        return jsonify({
            'ูุฌุงุญ': False,
            'ุฎุทุฃ': str(e)
        })

@app.route('/api/ูุนุงูุฌุฉ_ุทูุจ', methods=['POST'])
def ูุนุงูุฌุฉ_ุทูุจ():
    try:
        data = request.get_json()
        ูุต_ุงูุทูุจ = data.get('ูุต', '')
        
        ุฑุฏ, audio_data = ูุณุงุนุฏ.ูุนุงูุฌุฉ_ุงูุทูุจ(ูุต_ุงูุทูุจ)
        
        return jsonify({
            'ูุฌุงุญ': True,
            'ุฑุฏ': ุฑุฏ,
            'audio': audio_data,
            'ุงููุทุนู_ุงูุญุงูู': ูุณุงุนุฏ.ุงููุทุนู_ุงูุญุงูู,
            'ุงููุญุงุฏุซุงุช': ูุณุงุนุฏ.ุงููุญุงุฏุซุงุช
        })
        
    except Exception as e:
        return jsonify({
            'ูุฌุงุญ': False,
            'ุฎุทุฃ': str(e)
        })

@app.route('/api/ูุนุงูุฌุฉ_ุตูุช', methods=['POST'])
def ูุนุงูุฌุฉ_ุตูุช():
    try:
        if 'audio' not in request.files:
            return jsonify({'ูุฌุงุญ': False, 'ุฎุทุฃ': 'ูู ูุชู ุฅุฑุณุงู ููู ุตูุชู'})
        
        audio_file = request.files['audio']
        audio_data = audio_file.read()
        
        ุฑุฏ, audio_base64 = ูุณุงุนุฏ.ูุนุงูุฌุฉ_ุงูุทูุจ("", audio_data)
        
        return jsonify({
            'ูุฌุงุญ': True,
            'ุฑุฏ': ุฑุฏ,
            'audio': audio_base64,
            'ุงููุทุนู_ุงูุญุงูู': ูุณุงุนุฏ.ุงููุทุนู_ุงูุญุงูู,
            'ุงููุญุงุฏุซุงุช': ูุณุงุนุฏ.ุงููุญุงุฏุซุงุช
        })
        
    except Exception as e:
        return jsonify({
            'ูุฌุงุญ': False,
            'ุฎุทุฃ': str(e)
        })

@app.route('/api/ุงููุญุงุฏุซุงุช')
def ุงูุญุตูู_ุนูู_ุงููุญุงุฏุซุงุช():
    return jsonify(ูุณุงุนุฏ.ุงููุญุงุฏุซุงุช)

@app.route('/health')
def health_check():
    return jsonify({'status': 'healthy', 'service': 'SPOKEN PLATE'})

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    print(f"๐ ุจุฏุก ุชุดุบูู SPOKEN PLATE ุนูู ุงููููุฐ {port}")
    app.run(host='0.0.0.0', port=port, debug=True)